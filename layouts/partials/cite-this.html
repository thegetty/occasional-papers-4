{{/*

    THIS OVERRIDE FILE PARTIALLY HARD-CODES THE CITATIONS TO BE FOR THE
    ENTIRE PUBLICATION RATHER THAN PAGE SPECIFIC, AND ALSO IS IN A FORMAT
    FOR A SERIES PUBLICATION RATHER THAN A BOOK.



    Template for the "Cite this Page" feature. Called as a
    partial, such as:

    partial "cite-this.html" (dict "page" . "site" .Site "type" "chicago")

    Can accept "chicago" or "mla" as a type

    Follows Getty standard of using "et al" for more than three
    authors in Chicago citations, and more than two authors
    in MLA citations.

    ***Note***
    Edit this template with care as it is easy to introduce stray spaces occuring around punctuation.

    ***Note***
    Doesn't currently account for name combinations that might end with a period (Keaton, Alex P., Sammy Davis Jr.) and so in some cases may end up including two periods in a row after contributor lists. I wanted to solve this with something like the following, but the output from a template can't seem to be assigned as to a variable or passed to a function.

    {{ $contributors := template "page-contributors-chicago" .page }}
    {{ $endPunctuation := findRE "[[:punct:]]$" $contributors }}

    {{ $contributors }}{{ if $endPunctuation }}{{ else }}. {{ end }}

*/}}

{{ $citationType := .type }}

{{- if eq $citationType "chicago" -}}

  {{/* ------------  CHICAGO ------------ */}}
  {{- $endPunctuation := findRE "[!|?]$" .site.Data.publication.title -}}

  {{ template "publication-contributors" (dict "page" .page "Site" .site "type" $citationType) }}. “{{ .site.Data.publication.title }}{{ with .site.Data.publication.subtitle }}{{ if $endPunctuation }} {{ else }}: {{ end }}{{ . }}{{ end }}.” {{ with .site.Data.publication.series }}{{ . }}{{ end }}{{ with .site.Data.publication.number_in_series }} {{ . }}{{ end }}. {{ template "publishers-chicago" (dict "site" .site) }}{{ with .site.Data.publication.pub_date }}, {{ dateFormat "2006" . }}{{ end }}. <span class="url-string">{{ with .site.Data.publication.url }}{{ . }}{{ end }}</span>.

{{- else if eq $citationType "mla" -}}

  {{/* ------------  MLA ------------ */}}
  {{- $endPunctuation := findRE "[!|?]$" .site.Data.publication.title -}}

  {{ template "publication-contributors" (dict "page" .page "Site" .site "type" $citationType) }}. “{{ .site.Data.publication.title }}{{ with .site.Data.publication.subtitle }}{{ if $endPunctuation }} {{ else }}: {{ end }}{{ . }}{{ end }}.” {{ .site.Data.publication.series }}, no. {{ .site.Data.publication.number_in_series }}{{ with .site.Data.publication.pub_date }}, {{ dateFormat "2006" . }}{{ end }}. http://getty.edu/publications/occasional-papers-3/. Accessed <span class="cite-current-date">Aug. 29, 2019</span>.

{{- end -}}


{{- define "page-contributors-mla" -}}
{{- if .Page.Params.contributor -}}
  {{- $len := len .Page.Params.contributor -}}
  {{- range $index, $element := .Page.Params.contributor -}}
    {{ if eq $index 0 }}
    {{ template "contrib-name-reverse" (dict "site" $.Site "page" . )}}
    {{- else -}}
    {{- if eq $len 2 }}, and {{ template "contrib-name" (dict "site" $.Site "page" . )}}{{ end -}}
    {{- end -}}
  {{- end -}}
  {{- if gt $len 2 }}, et al{{ end -}}
{{- end -}}
{{- end -}}

{{- define "page-contributors-chicago" -}}
{{- if .Page.Params.contributor -}}
  {{- $len := len .Page.Params.contributor -}}
  {{- range $index, $element := .Page.Params.contributor -}}
    {{- if and (eq $len 1) (eq $index 0) -}}
    {{ template "contrib-name-reverse" (dict "site" $.Site "page" . )}}{{- else if eq $index 0 -}}
    {{ template "contrib-name-reverse" (dict "site" $.Site "page" . )}}, {{ end -}}

    {{- if or (and (eq $len 2) (eq $index 1)) (and (eq $len 3) (eq $index 2)) -}}
    and {{ template "contrib-name" (dict "site" $.Site "page" . )}}
    {{- end -}}

    {{- if or (and (gt $len 2) (eq $index 1)) (and (gt $len 3) (eq $index 2)) -}}
    {{ template "contrib-name" (dict "site" $.Site "page" . )}}, {{ end -}}
  {{- end -}}

  {{- if gt $len 3 -}}
  et al
  {{- end -}}

{{- end -}}
{{- end -}}



{{- define "publication-contributors" -}}

  {{ $citationType := .type }}

  {{ $contributors := (where $.Site.Data.publication.contributor "type" "primary") }}
  {{- $contributorLength := len $contributors -}}

  {{- $editors := (where $contributors "role" "eq" "editor") -}}
  {{- $editorLength := len $editors -}}

  {{/* If the primary contributors are listed as role: editor
    we need to add "ed(s)" or "editor(s)" to the list of contributor names
  --------------------------------------------------------------------------*/}}
  {{- $editorTag := "" -}}
  {{- if eq $editorLength 1 }}
    {{- if eq $citationType "chicago" -}}
      {{- $editorTag = "ed" -}}
    {{- else if eq $citationType "mla" -}}
      {{- $editorTag = "editor" -}}
    {{- end -}}
  {{- else if gt $editorLength 1 -}}
    {{- if eq $citationType "chicago" -}}
      {{- $editorTag = "eds" -}}
    {{- else if eq $citationType "mla" -}}
      {{- $editorTag = "editors" -}}
    {{- end -}}
  {{- end -}}

  {{/* Chicago suggests that et al be used for
  ------------------------------------------------------------------------*/}}
  {{- $maxLength := "" -}}
  {{- if eq $citationType "chicago" -}}
    {{- $maxLength = 7 -}}
  {{- else if eq $citationType "mla" -}}
    {{- $maxLength = 1 -}}
  {{- end -}}


  {{- range $index, $element := $contributors -}}


    {{/* If this is for Chicago format, and is one more than the max number of contributors, add "et al". Only add a period if there won't be an editorTag following it.
    ------------------------------------------------------------------------*/}}
    {{- if and (and (gt $contributorLength $maxLength) (eq $index $maxLength)) (eq $citationType "chicago") -}}

      et al{{ if $editorTag }}., {{ end -}}


    {{/* If this is for MLA format, and is the second contributor of more than two contributors, instead add "et al". Only add a period if there won't be an editorTag following it.
    ------------------------------------------------------------------------*/}}
    {{- else if and (and (gt $contributorLength (add $maxLength 1)) (eq $index 1)) (eq $citationType "mla") -}}

      et al{{ if $editorTag }}., {{ end -}}

    {{/* If this is more than the max and we've already added "et al", don't do anything for this contributor
    ------------------------------------------------------------------------*/}}
    {{- else if and (gt $contributorLength $maxLength) (gt $index $maxLength) -}}


    {{/* If this is the last name ...
    ------------------------------------------------------------------------*/}}
    {{- else if eq $index (sub $contributorLength 1) -}}

      {{/* First check if it's also the first name, and reverse it if so: LastName, FirstName
      ----------------------------------------------------------------------*/}}
      {{- if eq $index 0 -}}

        {{/* If there's a role tag to add, leave any ending punctuation in the name, and add a comma
        --------------------------------------------------------------------*/}}
        {{- if $editorTag -}}

            {{ template "contrib-name-reverse" (dict "site" $.Site "page" . )}},

        {{/* Otherwise strip any ending punctuation
        --------------------------------------------------------------------*/}}
        {{ else -}}

            {{ template "contrib-name-reverse-last" (dict "site" $.Site "page" . )}}

        {{- end -}}

      {{/* Second, if it's not the first name, display it in reading order. FirstName LastName
      ----------------------------------------------------------------------*/}}
      {{- else if gt $index 0 -}}

        {{/* If there's a role tag to add, leave any ending punctuation in the name, and add a comma
        --------------------------------------------------------------------*/}}
        {{- if ne $editorTag "" -}}

            and {{ template "contrib-name" (dict "site" $.Site "page" . )}},

        {{/* Otherwise strip any ending punctuation
        --------------------------------------------------------------------*/}}
        {{ else -}}

            and {{ template "contrib-name-last" (dict "site" $.Site "page" . )}}

        {{- end -}}

      {{- end -}}


    {{/* If this is the first name, reverse it and add a comma: LastName, FirstName,
    ------------------------------------------------------------------------*/}}
    {{- else if eq $index 0 -}}

          {{ template "contrib-name-reverse" (dict "site" $.Site "page" . )}},


    {{/* If this is a name in the middle of the list, just add it in with a comma: FirstName LastName,
    ------------------------------------------------------------------------*/}}
    {{- else if (gt $index 0) (lt $index (sub $contributorLength 1) ) -}}

      {{ template "contrib-name" (dict "site" $.Site "page" . )}},

    {{ end -}}


  {{/* End the range
  --------------------------------------------------------------------------*/}}
  {{- end -}}


  {{/* If there's a role tag to add, do so now
  --------------------------------------------------------------------------*/}}
  {{- with $editorTag -}} {{ . }}{{- end -}}


{{- end -}}










{{- define "publication-contributors-chicago" -}}

  {{- $lenEditor := len (where (where $.Site.Data.publication.contributor "type" "primary") "role" "eq" "editor") -}}

  {{- $editorTag := "" -}}
  {{- if eq $lenEditor 1 }}
    {{- $editorTag = "ed" -}}
  {{- else if gt $lenEditor 1 -}}
    {{- $editorTag = "eds" -}}
  {{- else }}
    {{- $editorTag = "" -}}
  {{- end -}}

  <h3>{{ $lenEditor}}: {{ $editorTag }}</h3>

  {{- $len := len (where $.Site.Data.publication.contributor "type" "primary") -}}
  {{- range $index, $element := (where $.Site.Data.publication.contributor "type" "primary") -}}
    {{- if and (eq $len 1) (eq $index 0) -}}
    {{- if gt $lenEditor 0 -}}{{ template "contrib-name-reverse" (dict "site" $.Site "page" . )}}{{ else }}{{ template "contrib-name-reverse-last" (dict "site" $.Site "page" . )}}{{ end }}{{- else if eq $index 0 -}}
    {{ template "contrib-name-reverse" (dict "site" $.Site "page" . )}}, {{ end -}}

    {{- if or (and (eq $len 2) (eq $index 1)) (and (eq $len 3) (eq $index 2)) -}}
    and {{ if gt $lenEditor 0 -}}{{ template "contrib-name" (dict "site" $.Site "page" . )}}{{ else }}{{ template "contrib-name-last" (dict "site" $.Site "page" . )}}{{ end }}
    {{- end -}}

    {{- if or (and (gt $len 2) (eq $index 1)) (and (gt $len 3) (eq $index 2)) -}}
    {{ template "contrib-name" (dict "site" $.Site "page" . )}}, {{ end -}}
  {{- end -}}

  {{- if gt $len 3 -}}
  et al
  {{- end -}}

  {{- if gt $lenEditor 0 -}}, {{ $editorTag }}{{- end -}}

{{- end -}}

{{- define "contrib-name-reverse" -}}
  {{- if .page.id -}}
    {{- range where .site.Data.publication.contributor "id" .page.id -}}
      {{ template "name-string-reverse" . }}
    {{- end -}}
  {{- else -}}
    {{ template "name-string-reverse" .page }}
  {{- end -}}
{{- end -}}

{{- define "contrib-name" -}}
  {{- if .page.id -}}
    {{- range where .site.Data.publication.contributor "id" .page.id -}}
      {{ template "name-string" . }}
    {{- end -}}
  {{- else -}}
    {{ template "name-string" .page }}
  {{- end -}}
{{- end -}}

{{- define "name-string" -}}
  {{- if .full_name -}}
    {{ .full_name }}
  {{- else -}}
    {{ printf "%s%s%s" .first_name " " .last_name }}
  {{- end -}}
{{- end -}}

{{- define "name-string-reverse" -}}
  {{- if .full_name -}}
    {{ .full_name }}
  {{- else -}}
    {{ printf "%s%s%s" .last_name ", " .first_name }}
  {{- end -}}
{{- end -}}


{{- define "contrib-name-reverse-last" -}}
  {{- if .page.id -}}
    {{- range where .site.Data.publication.contributor "id" .page.id -}}
      {{ template "name-string-reverse-last" . }}
    {{- end -}}
  {{- else -}}
    {{ template "name-string-reverse-last" .page }}
  {{- end -}}
{{- end -}}

{{- define "contrib-name-last" -}}
  {{- if .page.id -}}
    {{- range where .site.Data.publication.contributor "id" .page.id -}}
      {{ template "name-string-last" . }}
    {{- end -}}
  {{- else -}}
    {{ template "name-string-last" .page }}
  {{- end -}}
{{- end -}}

{{- define "name-string-last" -}}
  {{- if .full_name -}}
    {{ $nameLast := .full_name }}
    {{ replaceRE "[.]$" "" $nameLast }}
  {{- else -}}
    {{ $nameLast := printf "%s%s%s" .first_name " " .last_name }}
    {{ replaceRE "[.]$" "" $nameLast }}
  {{- end -}}
{{- end -}}

{{- define "name-string-reverse-last" -}}
  {{- if .full_name -}}
    {{ $nameLast := .full_name }}
    {{ replaceRE "[.]$" "" $nameLast }}
  {{- else -}}
    {{ $nameLast := printf "%s%s%s" .last_name ", " .first_name }}
    {{ replaceRE "[.]$" "" $nameLast }}
  {{- end -}}
{{- end -}}


{{- define "publishers-chicago" -}}
  {{ $len := len .site.Data.publication.publisher }}
  {{ range $index, $element := .site.Data.publication.publisher }}
    {{ if eq $index (sub $len 1) }}
    {{ .location }}: {{ .name }}{{ else }}
    {{ .location }}: {{ .name }}; {{ end }}
  {{- end }}
{{- end -}}

{{- define "publishers-mla" -}}
  {{ $len := len .site.Data.publication.publisher }}
  {{ range $index, $element := .site.Data.publication.publisher }}
    {{ if eq $index (sub $len 1) }}
    {{ .name }}{{ else }}
    {{ .name }}, {{ end }}
  {{- end }}
{{- end -}}
